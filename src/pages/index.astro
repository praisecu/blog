---
/**
 * Dark science-blog index (list rows w/ thumbnails + dashed dividers)
 * Auto-discovers posts from /src/pages/*.mdx
 *
 * Frontmatter supported:
 * - title (required)
 * - date (required)
 * - description (optional)
 * - tags (optional array)
 * - image (optional string, e.g. "/images/optical-flow.png")
 * - draft: true (optional to hide)
 */
const modules = import.meta.glob("./*.mdx", { eager: true });

// Ensure BASE always ends with a single trailing slash: "/" or "/blog/"
const BASE = (import.meta.env.BASE_URL || "/").replace(/\/?$/, "/");

function toPost(mod, filePath) {
  const fm = mod.frontmatter ?? {};
  const slug = filePath.split("/").pop().replace(/\.mdx$/, "");
  if (fm.draft === true) return null;

  const tags = Array.isArray(fm.tags) ? fm.tags : [];
  return {
    slug,
    url: `${BASE}${slug}/`,
    title: fm.title ?? slug,
    date: fm.date ?? "",
    description: fm.description ?? "",
    tags,
    image: fm.image ?? ""
  };
}

const posts = Object.entries(modules)
  .map(([path, mod]) => toPost(mod, path))
  .filter(Boolean)
  .sort((a, b) => (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0));
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Blog</title>

    <!-- Use BASE to work under /blog/ -->
    <link rel="stylesheet" href={`${BASE}src/styles/global.css`} />

    <style>
      :global(html), :global(body) {
        height: 100%;
      }

      /* Page background (screenshot-like) */
      body {
        background: radial-gradient(1200px 600px at 15% 10%, rgba(99,102,241,0.18), rgba(0,0,0,0)),
                    radial-gradient(900px 500px at 80% 30%, rgba(16,185,129,0.10), rgba(0,0,0,0)),
                    #07131f;
        color: rgba(255,255,255,0.92);
      }

      .wrap {
        max-width: 920px;
        margin: 0 auto;
        padding: 28px 18px 60px;
      }

      /* Header */
      .hero {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 16px;
        margin: 10px 0 18px;
      }

      .hero h1 {
        margin: 0;
        font-size: 40px;
        letter-spacing: -0.02em;
        font-weight: 850;
      }

      .hero p {
        margin: 0;
        max-width: 62ch;
        color: rgba(255,255,255,0.70);
        font-size: 14px;
        line-height: 1.5;
      }

      .top-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-shrink: 0;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.12);
        color: rgba(255,255,255,0.86);
        text-decoration: none;
        font-size: 13px;
        background: rgba(255,255,255,0.04);
      }
      .btn:hover { background: rgba(255,255,255,0.07); }

      /* Search bar */
      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin: 14px 0 18px;
      }
      .search {
        flex: 1;
        min-width: 240px;
        max-width: 520px;
        position: relative;
      }
      .search input {
        width: 100%;
        padding: 11px 12px 11px 38px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.12);
        outline: none;
        background: rgba(255,255,255,0.04);
        color: rgba(255,255,255,0.92);
        font-size: 14px;
      }
      .search input::placeholder { color: rgba(255,255,255,0.45); }
      .search svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.65;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
        color: rgba(255,255,255,0.74);
        font-size: 13px;
      }

      /* Post list */
      .list {
        margin-top: 6px;
        border-radius: 18px;
      }

      .row {
        display: grid;
        grid-template-columns: 92px 1fr;
        gap: 18px;
        padding: 18px 10px;
        text-decoration: none;
        color: inherit;
        border-radius: 16px;
        position: relative;
      }

      .row:hover {
        background: rgba(255,255,255,0.03);
      }

      .thumb {
        width: 92px;
        height: 92px;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.10);
        background: linear-gradient(135deg, rgba(99,102,241,0.22), rgba(245,158,11,0.14));
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .content h2 {
        margin: 0 0 8px;
        font-size: 20px;
        line-height: 1.2;
        letter-spacing: -0.01em;
        font-weight: 800;
      }

      .content p {
        margin: 0 0 12px;
        color: rgba(255,255,255,0.66);
        font-size: 13px;
        line-height: 1.55;
        max-width: 78ch;
      }

      .meta {
        display: flex;
        gap: 10px;
        align-items: center;
        color: rgba(255,255,255,0.55);
        font-size: 12px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(99,102,241,0.35);
        background: rgba(99,102,241,0.14);
        color: rgba(255,255,255,0.82);
        font-size: 12px;
      }

      .divider {
        border: none;
        border-top: 1px dashed rgba(147,197,253,0.28);
        margin: 0;
      }

      .empty {
        border: 1px dashed rgba(255,255,255,0.18);
        border-radius: 14px;
        padding: 18px;
        color: rgba(255,255,255,0.70);
        background: rgba(255,255,255,0.03);
      }

      @media (max-width: 560px) {
        .row { grid-template-columns: 74px 1fr; }
        .thumb { width: 74px; height: 74px; border-radius: 12px; }
        .content h2 { font-size: 18px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1>Blog</h1>
          <p>
            Technical notes with derivations, implementation details, and interactive visualizations.
            Expect geometry, estimation, robotics perception, and generative models.
          </p>
        </div>
        <div class="top-actions">
          <a class="btn" href="https://github.com/">Link to Code</a>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35m1.35-5.65a7 7 0 11-14 0 7 7 0 0114 0z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="q" type="search" placeholder="Search posts (title, tags, description)..." />
        </div>

        <div class="pill">
          <span id="count">{posts.length}</span>
          <span>posts</span>
        </div>
      </div>

      {posts.length === 0 ? (
        <div class="empty">
          No posts yet. Add MDX files in <code>src/pages/</code>.
        </div>
      ) : (
        <div class="list" id="list">
          {posts.map((p, i) => (
            <>
              <a
                class="row"
                href={p.url}
                data-title={p.title.toLowerCase()}
                data-desc={p.description.toLowerCase()}
                data-tags={p.tags.join(" ").toLowerCase()}
                aria-label={`Read: ${p.title}`}
              >
                <div class="thumb">
                  {p.image ? <img src={p.image} alt="" loading="lazy" /> : null}
                </div>

                <div class="content">
                  <h2>{p.title}</h2>
                  {p.description ? <p>{p.description}</p> : <p></p>}
                  <div class="meta">
                    {p.tags?.length ? <span class="tag">{p.tags[0]}</span> : <span class="tag">note</span>}
                    <span>{p.date}</span>
                  </div>
                </div>
              </a>

              {i !== posts.length - 1 ? <hr class="divider" /> : null}
            </>
          ))}
        </div>
      )}

      <script>
        const q = document.getElementById("q");
        const rows = Array.from(document.querySelectorAll("#list .row"));
        const count = document.getElementById("count");

        function filter() {
          const s = (q.value || "").trim().toLowerCase();
          let visible = 0;

          for (const r of rows) {
            const hay =
              (r.dataset.title || "") + " " +
              (r.dataset.desc || "") + " " +
              (r.dataset.tags || "");
            const ok = hay.includes(s);
            r.style.display = ok ? "" : "none";
            if (ok) visible++;
          }
          if (count) count.textContent = String(visible);
        }

        if (q) q.addEventListener("input", filter);
      </script>
    </div>
  </body>
</html>

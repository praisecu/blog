---
/**
 * Light science-blog index
 * - Featured (newest) post + compact list for the rest
 * - Auto-discovers posts from /src/pages/*.mdx
 */
const modules = import.meta.glob("./*.mdx", { eager: true });

// Ensure BASE always ends with a single trailing slash: "/" or "/blog/"
const BASE = (import.meta.env.BASE_URL || "/").replace(/\/?$/, "/");

function toPost(mod, filePath) {
  const fm = mod.frontmatter ?? {};
  const slug = filePath.split("/").pop().replace(/\.mdx$/, "");
  if (fm.draft === true) return null;

  const tags = Array.isArray(fm.tags) ? fm.tags : [];
  return {
    slug,
    url: `${BASE}${slug}/`,
    title: fm.title ?? slug,
    date: fm.date ?? "",
    description: fm.description ?? "",
    tags,
    image: fm.image ?? "",
    featured: fm.featured === true
  };
}

const posts = Object.entries(modules)
  .map(([path, mod]) => toPost(mod, path))
  .filter(Boolean)
  .sort((a, b) => (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0));

const featured = posts.find((p) => p.featured === true) ?? posts[0] ?? null;
const rest = posts.filter((p) => p !== featured);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>PRAISe Lab Blogs</title>

    <!-- Keep using your shared theme vars -->
    <link rel="stylesheet" href={`${BASE}src/styles/global.css`} />

    <style>
      :global(html), :global(body) { height: 100%; }

      /* Surface tokens for this page (change with theme) */
      :global(html) {
        --surface: rgba(255,255,255,0.72);
        --surface-strong: rgba(255,255,255,0.90);
        --surface-border: rgba(17,24,39,0.10);
        --ink-strong: rgba(17,24,39,0.92);
        --ink: rgba(17,24,39,0.78);
        --ink-muted: rgba(17,24,39,0.58);
        --shadow: 0 18px 55px rgba(15,23,42,0.07);

        /* Gold wash accents */
        --accent-1: rgba(65,56,0,0.10);
        --accent-2: rgba(65,56,0,0.06);
      }

      :global(html[data-theme="dark"]) {
        --surface: rgba(17,17,17,0.72);
        --surface-strong: rgba(17,17,17,0.88);
        --surface-border: rgba(255,255,255,0.10);
        --ink-strong: rgba(255,255,255,0.92);
        --ink: rgba(255,255,255,0.78);
        --ink-muted: rgba(255,255,255,0.58);
        --shadow: 0 18px 55px rgba(0,0,0,0.40);

        --accent-1: rgba(200,178,119,0.12);
        --accent-2: rgba(200,178,119,0.07);
      }

      /* Paper mode tokens for THIS page’s local surfaces */
      :global(html[data-theme="paper"]) {
        --surface: rgba(255,255,255,0.62);
        --surface-strong: rgba(255,255,255,0.80);
        --surface-border: rgba(42, 36, 0, 0.14);

        --ink-strong: rgba(17,24,39,0.92);
        --ink: rgba(17,24,39,0.78);
        --ink-muted: rgba(17,24,39,0.58);

        --shadow: 0 18px 55px rgba(15,23,42,0.06);

        --accent-1: rgba(65,56,0,0.10);
        --accent-2: rgba(65,56,0,0.06);
      }

      body {
        background:
          radial-gradient(900px 520px at 15% 10%, var(--accent-1), rgba(255,255,255,0)),
          radial-gradient(900px 520px at 85% 20%, var(--accent-2), rgba(255,255,255,0)),
          var(--bg);
        color: var(--fg);
      }

      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 22px 18px 70px; /* a bit tighter because topbar is present */
      }

      /* Give the topbar some breathing room on index */
      .topbar {
        margin-bottom: 18px;
      }

      .hero {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 16px;
        margin: 6px 0 18px;
      }

      .hero h1 {
        margin: 0;
        font-size: 42px;
        letter-spacing: -0.02em;
        font-weight: 800;
        color: var(--ink-strong);
      }

      .hero p {
        margin: 0;
        max-width: 70ch;
        color: var(--ink);
        font-size: 14px;
        line-height: 1.55;
      }

      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin: 14px 0 18px;
      }

      .search {
        flex: 1;
        min-width: 240px;
        max-width: 560px;
        position: relative;
      }

      .search input {
        width: 100%;
        padding: 11px 12px 11px 38px;
        border-radius: 12px;
        border: 1px solid var(--surface-border);
        outline: none;
        background: var(--surface);
        color: var(--ink-strong);
        font-size: 14px;
      }
      .search input::placeholder { color: var(--ink-muted); }

      .search svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.55;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        border-radius: 999px;
        border: 1px solid var(--surface-border);
        background: var(--surface);
        color: var(--ink-muted);
        font-size: 13px;
      }

      /* Section headings */
      .section-title {
        margin: 18px 0 10px;
        font-size: 12px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--ink-muted);
        font-weight: 750;
      }

      /* Featured card */
      .featured {
        border-radius: 20px;
        background: var(--surface);
        border: 1px solid rgba(17,24,39,0.08);
        box-shadow: var(--shadow);
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 18px;
        padding: 18px;
      }
      :global(html[data-theme="dark"]) .featured {
        border-color: rgba(255,255,255,0.10);
      }

      .featured:hover {
        background: var(--surface-strong);
      }

      .featured-thumb {
        width: 220px;
        height: 160px;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--surface-border);
        background: linear-gradient(135deg, rgba(65,56,0,0.18), rgba(65,56,0,0.08));
      }

      .featured-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .featured-content h2 {
        margin: 0 0 10px;
        font-size: 26px;
        line-height: 1.15;
        letter-spacing: -0.015em;
        font-weight: 850;
        color: var(--ink-strong);
      }

      .featured-content p {
        margin: 0 0 14px;
        color: var(--ink);
        font-size: 14px;
        line-height: 1.6;
        max-width: 80ch;
      }

      .meta {
        display: flex;
        gap: 10px;
        align-items: center;
        color: var(--ink-muted);
        font-size: 12px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(65,56,0,0.25);
        background: rgba(65,56,0,0.10);
        color: var(--ink);
        font-size: 12px;
      }
      :global(html[data-theme="dark"]) .tag {
        border-color: rgba(200,178,119,0.25);
        background: rgba(200,178,119,0.10);
      }

      .cta {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--surface-border);
        background: var(--surface-strong);
        color: var(--ink);
        font-size: 12px;
        font-weight: 700;
      }

      /* Rest list container */
      .list {
        margin-top: 12px;
        border-radius: 18px;
        background: var(--surface);
        border: 1px solid rgba(17,24,39,0.08);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      :global(html[data-theme="dark"]) .list {
        border-color: rgba(255,255,255,0.10);
      }

      .row {
        display: grid;
        grid-template-columns: 92px 1fr;
        gap: 18px;
        padding: 18px 16px;
        text-decoration: none;
        color: inherit;
      }

      .row:hover {
        background: rgba(65,56,0,0.06);
      }
      :global(html[data-theme="dark"]) .row:hover {
        background: rgba(200,178,119,0.08);
      }

      .thumb {
        width: 92px;
        height: 92px;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid var(--surface-border);
        background: linear-gradient(135deg, rgba(65,56,0,0.18), rgba(65,56,0,0.08));
      }

      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .content h3 {
        margin: 0 0 8px;
        font-size: 18px;
        line-height: 1.25;
        letter-spacing: -0.01em;
        font-weight: 800;
        color: var(--ink-strong);
      }

      .content .excerpt {
        margin: 0 0 12px;
        color: var(--ink);
        font-size: 13px;
        line-height: 1.55;
        max-width: 84ch;
      }

      .divider {
        border: none;
        border-top: 1px dashed rgba(17,24,39,0.22);
        margin: 0;
      }
      :global(html[data-theme="dark"]) .divider {
        border-top-color: rgba(255,255,255,0.18);
      }

      .empty {
        border: 1px dashed rgba(17,24,39,0.18);
        border-radius: 14px;
        padding: 18px;
        color: var(--ink);
        background: var(--surface);
      }
      :global(html[data-theme="dark"]) .empty {
        border-color: rgba(255,255,255,0.18);
      }

      @media (max-width: 820px) {
        .featured { grid-template-columns: 1fr; }
        .featured-thumb { width: 100%; height: 200px; }
      }

      @media (max-width: 560px) {
        .row { grid-template-columns: 74px 1fr; padding: 16px 14px; }
        .thumb { width: 74px; height: 74px; border-radius: 12px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <!-- NEW: topbar like post pages -->
      <div class="topbar">
        <div class="topbar-left">
          <a class="topbar-link topbar-link-muted" href="/blog/">Blog Home</a>
        </div>

        <div class="topbar-center">
          <a class="topbar-link topbar-link-primary" href="/">PRAISe Lab Home</a>
        </div>

        <div class="topbar-right">
          <button
            id="themeToggle"
            class="theme-toggle theme-toggle-icon"
            type="button"
            aria-label="Theme: Light. Click to change."
            title="Theme: Light (click to change)"
          >
            <span id="themeIcon" aria-hidden="true">☀</span>
            <span id="themeLabel">Light</span>
          </button>
        </div>
      </div>

      <div class="hero">
        <div>
          <h1>PRAISe Lab Blogs</h1>
          <p>
            Technical notes with derivations, implementation details, and visualizations.
            Geometry, estimation, robotics perception, and generative models.
          </p>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35m1.35-5.65a7 7 0 11-14 0 7 7 0 0114 0z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="q" type="search" placeholder="Search posts (title, tags, description)..." />
        </div>

        <div class="pill">
          <span id="count">{posts.length}</span>
          <span>posts</span>
        </div>
      </div>

      {posts.length === 0 ? (
        <div class="empty">
          No posts yet. Add MDX files in <code>src/pages/</code>.
        </div>
      ) : (
        <>
          {featured ? (
            <>
              <div class="section-title">Pinned</div>
              <a
                class="featured"
                href={featured.url}
                id="featured"
                data-title={featured.title.toLowerCase()}
                data-desc={featured.description.toLowerCase()}
                data-tags={featured.tags.join(" ").toLowerCase()}
                aria-label={`Read featured: ${featured.title}`}
              >
                <div class="featured-thumb">
                  {featured.image ? <img src={featured.image} alt="" loading="lazy" /> : null}
                </div>

                <div class="featured-content">
                  <h2>{featured.title}</h2>
                  {featured.description ? <p>{featured.description}</p> : <p>New post.</p>}

                  <div class="meta">
                    {featured.tags?.length ? <span class="tag">{featured.tags[0]}</span> : <span class="tag">note</span>}
                    <span>{featured.date}</span>
                    <span class="cta">Read</span>
                  </div>
                </div>
              </a>
            </>
          ) : null}

          {rest.length ? (
            <>
              <div class="section-title">Latest</div>
              <div class="list" id="list">
                {rest.map((p, i) => (
                  <>
                    <a
                      class="row"
                      href={p.url}
                      data-title={p.title.toLowerCase()}
                      data-desc={p.description.toLowerCase()}
                      data-tags={p.tags.join(" ").toLowerCase()}
                      aria-label={`Read: ${p.title}`}
                    >
                      <div class="thumb">
                        {p.image ? <img src={p.image} alt="" loading="lazy" /> : null}
                      </div>

                      <div class="content">
                        <h3>{p.title}</h3>
                        {p.description ? <p class="excerpt">{p.description}</p> : null}
                        <div class="meta">
                          {p.tags?.length ? <span class="tag">{p.tags[0]}</span> : <span class="tag">note</span>}
                          <span>{p.date}</span>
                        </div>
                      </div>
                    </a>

                    {i !== rest.length - 1 ? <hr class="divider" /> : null}
                  </>
                ))}
              </div>
            </>
          ) : null}
        </>
      )}

      <script is:inline>
        // ---- Theme (3-state): Light -> Dark -> Paper -> Light ----
        (() => {
          const STORAGE_KEY = "theme"; // "light" | "dark" | "paper"
          const root = document.documentElement;

          const btn = document.getElementById("themeToggle");
          const icon = document.getElementById("themeIcon");
          const label = document.getElementById("themeLabel");
          if (!btn) return;

          const ORDER = ["light", "dark", "paper"];
          const NAME = { light: "Light", dark: "Dark", paper: "Paper" };
          const ICON = { light: "☀", dark: "☾", paper: "⟡" };

          const normalize = (v) => (ORDER.includes(v) ? v : "light");

          const apply = (t) => {
            root.dataset.theme = t;
            if (label) label.textContent = NAME[t];
            if (icon) icon.textContent = ICON[t];
            btn.setAttribute("aria-label", `Theme: ${NAME[t]}. Click to change.`);
            btn.setAttribute("title", `Theme: ${NAME[t]} (click to change)`);
          };

          apply(normalize(localStorage.getItem(STORAGE_KEY)));

          btn.addEventListener("click", () => {
            const cur = normalize(root.dataset.theme);
            const next = ORDER[(ORDER.indexOf(cur) + 1) % ORDER.length];
            localStorage.setItem(STORAGE_KEY, next);
            apply(next);
          });
        })();
      </script>

      <script>
        // ---- Search filtering ----
        const q = document.getElementById("q");
        const featured = document.getElementById("featured");
        const rows = Array.from(document.querySelectorAll("#list .row"));
        const count = document.getElementById("count");

        function matches(el, s) {
          if (!el) return false;
          const hay =
            (el.dataset.title || "") + " " +
            (el.dataset.desc || "") + " " +
            (el.dataset.tags || "");
          return hay.includes(s);
        }

        function filter() {
          const s = (q.value || "").trim().toLowerCase();
          let visible = 0;

          if (featured) {
            const ok = s.length === 0 ? true : matches(featured, s);
            featured.style.display = ok ? "" : "none";
            if (ok) visible++;
          }

          for (const r of rows) {
            const ok = s.length === 0 ? true : matches(r, s);
            r.style.display = ok ? "" : "none";
            if (ok) visible++;
          }

          if (count) count.textContent = String(visible);
        }

        if (q) q.addEventListener("input", filter);
      </script>
    </div>
  </body>
</html>

---
/**
 * Light science-blog index
 * - Featured (newest) post + compact list for the rest
 * - Auto-discovers posts from /src/pages/*.mdx
 */
const modules = import.meta.glob("./*.mdx", { eager: true });

// Ensure BASE always ends with a single trailing slash: "/" or "/blog/"
const BASE = (import.meta.env.BASE_URL || "/").replace(/\/?$/, "/");

function toPost(mod, filePath) {
  const fm = mod.frontmatter ?? {};
  const slug = filePath.split("/").pop().replace(/\.mdx$/, "");
  if (fm.draft === true) return null;

  const tags = Array.isArray(fm.tags) ? fm.tags : [];
  return {
    slug,
    url: `${BASE}${slug}/`,
    title: fm.title ?? slug,
    date: fm.date ?? "",
    description: fm.description ?? "",
    tags,
    image: fm.image ?? ""
  };
}

const posts = Object.entries(modules)
  .map(([path, mod]) => toPost(mod, path))
  .filter(Boolean)
  .sort((a, b) => (new Date(b.date).getTime() || 0) - (new Date(a.date).getTime() || 0));

const featured = posts.find((p) => p.featured === true) ?? posts[0] ?? null;
const rest = posts.filter((p) => p !== featured);
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Blog</title>

    <link rel="stylesheet" href={`${BASE}src/styles/global.css`} />

    <style>
      :global(html), :global(body) { height: 100%; }

      body {
        background:
          radial-gradient(900px 520px at 15% 10%, rgba(59,130,246,0.10), rgba(255,255,255,0)),
          radial-gradient(900px 520px at 85% 20%, rgba(245,158,11,0.08), rgba(255,255,255,0)),
          #f7f7fb;
        color: #0f172a;
      }

      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 34px 18px 70px;
      }

      .hero {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 16px;
        margin: 6px 0 18px;
      }

      .hero h1 {
        margin: 0;
        font-size: 42px;
        letter-spacing: -0.02em;
        font-weight: 850;
      }

      .hero p {
        margin: 0;
        max-width: 70ch;
        color: rgba(15,23,42,0.72);
        font-size: 14px;
        line-height: 1.55;
      }

      .top-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-shrink: 0;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid rgba(15,23,42,0.10);
        color: rgba(15,23,42,0.82);
        text-decoration: none;
        font-size: 13px;
        background: rgba(255,255,255,0.65);
        box-shadow: 0 8px 22px rgba(15,23,42,0.05);
      }
      .btn:hover { background: rgba(255,255,255,0.9); }

      .toolbar {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin: 14px 0 18px;
      }

      .search {
        flex: 1;
        min-width: 240px;
        max-width: 560px;
        position: relative;
      }

      .search input {
        width: 100%;
        padding: 11px 12px 11px 38px;
        border-radius: 12px;
        border: 1px solid rgba(15,23,42,0.10);
        outline: none;
        background: rgba(255,255,255,0.75);
        color: rgba(15,23,42,0.92);
        font-size: 14px;
      }
      .search input::placeholder { color: rgba(15,23,42,0.45); }

      .search svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.55;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 12px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,0.10);
        background: rgba(255,255,255,0.65);
        color: rgba(15,23,42,0.70);
        font-size: 13px;
      }

      /* Section headings */
      .section-title {
        margin: 18px 0 10px;
        font-size: 12px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: rgba(15,23,42,0.55);
        font-weight: 750;
      }

      /* Featured card */
      .featured {
        border-radius: 20px;
        background: rgba(255,255,255,0.70);
        border: 1px solid rgba(15,23,42,0.08);
        box-shadow: 0 18px 55px rgba(15,23,42,0.07);
        overflow: hidden;
        text-decoration: none;
        color: inherit;
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 18px;
        padding: 18px;
      }

      .featured:hover {
        background: rgba(255,255,255,0.92);
      }

      .featured-thumb {
        width: 220px;
        height: 160px;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(15,23,42,0.10);
        background: linear-gradient(135deg, rgba(59,130,246,0.18), rgba(245,158,11,0.12));
      }

      .featured-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .featured-content h2 {
        margin: 0 0 10px;
        font-size: 26px;
        line-height: 1.15;
        letter-spacing: -0.015em;
        font-weight: 900;
      }

      .featured-content p {
        margin: 0 0 14px;
        color: rgba(15,23,42,0.72);
        font-size: 14px;
        line-height: 1.6;
        max-width: 80ch;
      }

      .meta {
        display: flex;
        gap: 10px;
        align-items: center;
        color: rgba(15,23,42,0.55);
        font-size: 12px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(59,130,246,0.25);
        background: rgba(59,130,246,0.10);
        color: rgba(15,23,42,0.78);
        font-size: 12px;
      }

      .cta {
        margin-left: auto;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,0.10);
        background: rgba(255,255,255,0.85);
        color: rgba(15,23,42,0.80);
        font-size: 12px;
        font-weight: 700;
      }

      /* Rest list container */
      .list {
        margin-top: 12px;
        border-radius: 18px;
        background: rgba(255,255,255,0.65);
        border: 1px solid rgba(15,23,42,0.08);
        box-shadow: 0 18px 55px rgba(15,23,42,0.07);
        overflow: hidden;
      }

      .row {
        display: grid;
        grid-template-columns: 92px 1fr;
        gap: 18px;
        padding: 18px 16px;
        text-decoration: none;
        color: inherit;
      }

      .row:hover {
        background: rgba(59,130,246,0.06);
      }

      .thumb {
        width: 92px;
        height: 92px;
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(15,23,42,0.10);
        background: linear-gradient(135deg, rgba(59,130,246,0.18), rgba(245,158,11,0.12));
      }

      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .content h3 {
        margin: 0 0 8px;
        font-size: 18px;
        line-height: 1.25;
        letter-spacing: -0.01em;
        font-weight: 850;
      }

      .content .excerpt {
        margin: 0 0 12px;
        color: rgba(15,23,42,0.70);
        font-size: 13px;
        line-height: 1.55;
        max-width: 84ch;
      }

      .divider {
        border: none;
        border-top: 1px dashed rgba(15,23,42,0.22);
        margin: 0;
      }

      .empty {
        border: 1px dashed rgba(15,23,42,0.18);
        border-radius: 14px;
        padding: 18px;
        color: rgba(15,23,42,0.70);
        background: rgba(255,255,255,0.65);
      }

      @media (max-width: 820px) {
        .featured {
          grid-template-columns: 1fr;
        }
        .featured-thumb {
          width: 100%;
          height: 200px;
        }
      }

      @media (max-width: 560px) {
        .row { grid-template-columns: 74px 1fr; padding: 16px 14px; }
        .thumb { width: 74px; height: 74px; border-radius: 12px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="hero">
        <div>
          <h1>Blog</h1>
          <p>
            Technical notes with derivations, implementation details, and visualizations.
            Geometry, estimation, robotics perception, and generative models.
          </p>
        </div>
        <div class="top-actions">
          <a class="btn" href="https://github.com/">Link to Code</a>
        </div>
      </div>

      <div class="toolbar">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.35-4.35m1.35-5.65a7 7 0 11-14 0 7 7 0 0114 0z"
              stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <input id="q" type="search" placeholder="Search posts (title, tags, description)..." />
        </div>

        <div class="pill">
          <span id="count">{posts.length}</span>
          <span>posts</span>
        </div>
      </div>

      {posts.length === 0 ? (
        <div class="empty">
          No posts yet. Add MDX files in <code>src/pages/</code>.
        </div>
      ) : (
        <>
          {featured ? (
            <>
              <div class="section-title">Featured</div>
              <a
                class="featured"
                href={featured.url}
                id="featured"
                data-title={featured.title.toLowerCase()}
                data-desc={featured.description.toLowerCase()}
                data-tags={featured.tags.join(" ").toLowerCase()}
                aria-label={`Read featured: ${featured.title}`}
              >
                <div class="featured-thumb">
                  {featured.image ? <img src={featured.image} alt="" loading="lazy" /> : null}
                </div>

                <div class="featured-content">
                  <h2>{featured.title}</h2>
                  {featured.description ? (
                    <p>{featured.description}</p>
                  ) : (
                    <p>New post.</p>
                  )}

                  <div class="meta">
                    {featured.tags?.length ? <span class="tag">{featured.tags[0]}</span> : <span class="tag">note</span>}
                    <span>{featured.date}</span>
                    <span class="cta">Read â†—</span>
                  </div>
                </div>
              </a>
            </>
          ) : null}

          {rest.length ? (
            <>
              <div class="section-title">Latest</div>
              <div class="list" id="list">
                {rest.map((p, i) => (
                  <>
                    <a
                      class="row"
                      href={p.url}
                      data-title={p.title.toLowerCase()}
                      data-desc={p.description.toLowerCase()}
                      data-tags={p.tags.join(" ").toLowerCase()}
                      aria-label={`Read: ${p.title}`}
                    >
                      <div class="thumb">
                        {p.image ? <img src={p.image} alt="" loading="lazy" /> : null}
                      </div>

                      <div class="content">
                        <h3>{p.title}</h3>
                        {p.description ? <p class="excerpt">{p.description}</p> : null}
                        <div class="meta">
                          {p.tags?.length ? <span class="tag">{p.tags[0]}</span> : <span class="tag">note</span>}
                          <span>{p.date}</span>
                        </div>
                      </div>
                    </a>

                    {i !== rest.length - 1 ? <hr class="divider" /> : null}
                  </>
                ))}
              </div>
            </>
          ) : null}
        </>
      )}

      <script>
        const q = document.getElementById("q");
        const featured = document.getElementById("featured");
        const rows = Array.from(document.querySelectorAll("#list .row"));
        const count = document.getElementById("count");

        function matches(el, s) {
          if (!el) return false;
          const hay =
            (el.dataset.title || "") + " " +
            (el.dataset.desc || "") + " " +
            (el.dataset.tags || "");
          return hay.includes(s);
        }

        function filter() {
          const s = (q.value || "").trim().toLowerCase();
          let visible = 0;

          // Featured
          if (featured) {
            const ok = s.length === 0 ? true : matches(featured, s);
            featured.style.display = ok ? "" : "none";
            if (ok) visible++;
          }

          // Rest
          for (const r of rows) {
            const ok = s.length === 0 ? true : matches(r, s);
            r.style.display = ok ? "" : "none";
            if (ok) visible++;
          }

          if (count) count.textContent = String(visible);
        }

        if (q) q.addEventListener("input", filter);
      </script>
    </div>
  </body>
</html>

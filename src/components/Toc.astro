---
const headings = Astro.props.headings ?? [];
const filtered = headings.filter((h) => h.depth === 2 || h.depth === 3);

function indent(depth) {
  return depth === 3 ? "14px" : "0px";
}
---

<nav class="toc" aria-label="Table of contents">
  <div class="toc-title">CONTENTS</div>

  {filtered.map((h) => (
    <a
      class="toc-link"
      href={`#${h.slug}`}
      style={`margin-left:${indent(h.depth)};`}
      data-toc-link
    >
      {h.text}
    </a>
  ))}
</nav>

<style>
  .toc-title {
    font-size: 12px;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.55);
    font-weight: 800;
    margin-bottom: 10px;
  }

  .toc-link {
    position: relative;
    display: block;
    padding: 8px 10px 8px 14px; /* space for left bar */
    border-radius: 10px;
    text-decoration: none;
    font-size: 13px;
    line-height: 1.35;
    color: rgba(15, 23, 42, 0.72);
    transition: background 120ms ease, color 120ms ease;
  }

  .toc-link:hover {
    background: var(--brand-wash);
    color: rgba(17, 24, 39, 0.92);
  }

  /* Left accent bar (hidden by default) */
  .toc-link::before {
    content: "";
    position: absolute;
    left: 6px;
    top: 7px;
    bottom: 7px;
    width: 3px;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.0);
    transition: background 120ms ease;
  }

  /* Active state: subtle fill + strong left bar */
  .toc-link.is-active {
    background: var(--brand-wash);
    color: var(--brand-ink);
    font-weight: 780;
  }
  .toc-link.is-active::before {
    background: var(--brand-gold);
  }

  .toc a:hover {
    background: var(--brand-wash);
    border-left-color: rgba(139, 107, 0, 0.55);
    color: var(--fg);
    text-decoration: none;
  }

  .toc a[data-active="true"] {
    background: var(--brand-wash);
    border-left-color: var(--brand-gold);
    color: var(--fg);
  }

  .brand-bar {
    background: var(--brand-ink);
    color: #fff;
    border-radius: 10px;
  }

</style>

<script is:inline>
  (() => {
    const toc = document.querySelector(".toc");
    if (!toc) return;

    const links = Array.from(toc.querySelectorAll("a[data-toc-link]"));
    if (!links.length) return;

    const targets = links
      .map((a) => {
        const href = a.getAttribute("href");
        if (!href || !href.startsWith("#")) return null;
        const id = decodeURIComponent(href.slice(1));
        return document.getElementById(id);
      })
      .filter(Boolean);

    const clear = () => links.forEach((a) => a.classList.remove("is-active"));

    const setActiveById = (id) => {
      if (!id) return;
      clear();
      const active = links.find((a) => decodeURIComponent(a.getAttribute("href").slice(1)) === id);
      if (active) active.classList.add("is-active");
    };

    // 1) If loaded with a hash, highlight immediately
    if (location.hash) setActiveById(decodeURIComponent(location.hash.slice(1)));

    // 2) Update on hashchange (back/forward navigation)
    window.addEventListener("hashchange", () => {
      if (location.hash) setActiveById(decodeURIComponent(location.hash.slice(1)));
    });

    // 3) Update immediately on click
    links.forEach((a) => {
      a.addEventListener("click", () => {
        const href = a.getAttribute("href");
        if (href && href.startsWith("#")) setActiveById(decodeURIComponent(href.slice(1)));
      });
    });

    // 4) Scroll spy via IntersectionObserver
    const io = new IntersectionObserver(
      (entries) => {
        const visible = entries
          .filter((e) => e.isIntersecting)
          .sort((a, b) => a.boundingClientRect.top - b.boundingClientRect.top);

        if (visible.length) setActiveById(visible[0].target.id);
      },
      {
        root: null,
        rootMargin: "-18% 0px -72% 0px",
        threshold: 0.01
      }
    );

    targets.forEach((t) => io.observe(t));
  })();
</script>

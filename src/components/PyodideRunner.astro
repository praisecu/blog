---
const { title = "Python (Pyodide)", initialCode = "", height = 220 } = Astro.props;
---

<section class="py-runner">
  {title && <h3 class="py-title">{title}</h3>}

  <div class="py-grid">
    <textarea class="py-editor" style={`height:${height}px`} spellcheck="false">{initialCode}</textarea>

    <div class="py-actions">
      <button class="py-run">Run</button>
      <span class="py-status">Loading Pyodide…</span>
    </div>

    <pre class="py-stdout" aria-label="stdout"></pre>
    <pre class="py-stderr" aria-label="stderr"></pre>

    <div class="py-figure">
      <img class="py-img" alt="matplotlib output" />
    </div>
  </div>
</section>

<style>
  .py-runner { margin: 1.25rem 0; }
  .py-title { margin: 0 0 0.5rem 0; }
  .py-grid { display: grid; gap: 0.75rem; }
  .py-editor { width: 100%; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9rem; padding: 0.75rem; border: 1px solid rgba(0,0,0,0.15); border-radius: 10px; }
  .py-actions { display: flex; align-items: center; gap: 0.75rem; }
  .py-run { padding: 0.45rem 0.85rem; border-radius: 10px; border: 1px solid rgba(0,0,0,0.2); cursor: pointer; }
  .py-status { opacity: 0.8; font-size: 0.95rem; }
  .py-stdout, .py-stderr { white-space: pre-wrap; padding: 0.75rem; border-radius: 10px; border: 1px solid rgba(0,0,0,0.15); min-height: 3.5rem; }
  .py-stderr { border-color: rgba(255,0,0,0.25); }
  .py-figure { padding: 0.75rem; border-radius: 10px; border: 1px solid rgba(0,0,0,0.15); }
  .py-img { max-width: 100%; height: auto; display: none; }
</style>

<script type="module">
  import { loadPyodide } from "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.mjs";

  const root = document.currentScript.closest(".py-runner");
  const editor = root.querySelector(".py-editor");
  const btn = root.querySelector(".py-run");
  const statusEl = root.querySelector(".py-status");
  const outEl = root.querySelector(".py-stdout");
  const errEl = root.querySelector(".py-stderr");
  const imgEl = root.querySelector(".py-img");

  function setStatus(s) { statusEl.textContent = s; }

  // Shared pyodide instance across all runners on the page.
  const globalKey = "__PYODIDE_SINGLETON__";
  async function getPyodide() {
    if (window[globalKey]) return window[globalKey];
    setStatus("Loading Pyodide (first load can take ~10–30s) …");
    const pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/" });
    // Ensure numpy/matplotlib are available. (These are part of the full distribution.)
    await pyodide.loadPackage(["numpy", "matplotlib"]);
    window[globalKey] = pyodide;
    return pyodide;
  }

  function clearIO() {
    outEl.textContent = "";
    errEl.textContent = "";
    imgEl.style.display = "none";
    imgEl.removeAttribute("src");
  }

  // Capture print() output.
  function makeStdout() {
    return (s) => { outEl.textContent += s + "\n"; };
  }

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    clearIO();

    try {
      const pyodide = await getPyodide();
      setStatus("Running…");

      // Provide a JS stdout hook to Python.
      pyodide.globals.set("__js_stdout__", makeStdout());

      const userCode = editor.value;

      // Force matplotlib to render to a PNG buffer and return it to JS.
      const wrapped = `
import sys, io, base64
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
from js import __js_stdout__

class _Writer:
    def write(self, s): 
        if s is None: return
        s = str(s)
        if s.strip() == "": 
            return
        __js_stdout__(s.rstrip())
    def flush(self): 
        return

sys.stdout = _Writer()
sys.stderr = _Writer()

# --- user code ---
${userCode}
# --- end user code ---

# If a figure exists, serialize the most recent one.
_png_b64 = None
try:
    fig = plt.gcf()
    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches="tight", dpi=150)
    buf.seek(0)
    _png_b64 = base64.b64encode(buf.read()).decode("ascii")
except Exception:
    _png_b64 = None

_png_b64
`;

      const b64 = await pyodide.runPythonAsync(wrapped);
      if (b64 && typeof b64 === "string") {
        imgEl.src = "data:image/png;base64," + b64;
        imgEl.style.display = "block";
      }
      setStatus("Done.");
    } catch (e) {
      errEl.textContent += String(e);
      setStatus("Error.");
    } finally {
      btn.disabled = false;
    }
  });

  // Initialize eagerly so the page shows readiness.
  getPyodide()
    .then(() => setStatus("Ready."))
    .catch((e) => { errEl.textContent = String(e); setStatus("Error loading Pyodide."); });
</script>

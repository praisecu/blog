---
const { title = "Python (Pyodide)", initialCode = "", height = 240, id } = Astro.props;
const uid = id ?? `py_${Math.random().toString(36).slice(2, 10)}`;
---

<section class="py-runner" data-py-runner={uid}>
  {title && <h3 class="py-title">{title}</h3>}

  <div class="py-window">
    <div class="py-windowbar">
      <div class="py-dots" aria-hidden="true">
        <span class="dot red"></span>
        <span class="dot yellow"></span>
        <span class="dot green"></span>
      </div>
      <div class="py-windowtitle">python</div>
      <div class="py-windowspacer" aria-hidden="true"></div>
    </div>

    <div class="py-body">
      <textarea class="py-editor" style={`height:${height}px`} spellcheck="false">{initialCode}</textarea>

      <div class="py-actions">
        <button class="py-run" type="button">Run</button>
        <span class="py-status">Idle.</span>
      </div>

      <pre class="py-stdout is-empty" aria-label="stdout"></pre>
      <pre class="py-stderr is-empty" aria-label="stderr"></pre>

      <div class="py-figure">
        <img class="py-img" alt="matplotlib output" />
      </div>
    </div>
  </div>
</section>

<style>
  .py-runner { margin: 1.5rem 0; }
  .py-title { margin: 0 0 0.75rem 0; }

  /* "Code window" look */
  .py-window {
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.16);
    overflow: hidden;
    background: #0f1117;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  }
  :global([data-theme="dark"]) .py-window {
    border-color: rgba(255,255,255,0.14);
    box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  }

  .py-windowbar {
    display: grid;
    grid-template-columns: 84px 1fr 84px;
    align-items: center;
    padding: 10px 12px;
    background: rgba(255,255,255,0.04);
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .py-dots { display: flex; gap: 8px; align-items: center; }
  .dot { width: 11px; height: 11px; border-radius: 999px; display: inline-block; opacity: 0.9; }
  .dot.red { background: #ff5f57; }
  .dot.yellow { background: #febc2e; }
  .dot.green { background: #28c840; }

  .py-windowtitle {
    text-align: center;
    font-size: 0.85rem;
    letter-spacing: 0.02em;
    color: rgba(255,255,255,0.72);
    user-select: none;
  }

  .py-body { padding: 14px; display: grid; gap: 12px; }

  .py-editor {
    width: 100%;
    resize: vertical;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.10);
    background: #0b0d12;
    color: rgba(255,255,255,0.92);
    padding: 14px 14px;
    line-height: 1.45;
    font-size: 0.95rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    outline: none;
  }
  .py-editor:focus {
    border-color: rgba(130,170,255,0.55);
    box-shadow: 0 0 0 3px rgba(130,170,255,0.18);
  }

  .py-actions { display: flex; align-items: center; gap: 10px; }
  .py-run {
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.16);
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.9);
    cursor: pointer;
    font-weight: 600;
  }
  .py-run:hover { background: rgba(255,255,255,0.10); }
  .py-run:disabled { opacity: 0.6; cursor: not-allowed; }

  .py-status { font-size: 0.95rem; color: rgba(255,255,255,0.68); }

  .py-stdout, .py-stderr {
    white-space: pre-wrap;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.10);
    background: #0b0d12;
    color: rgba(255,255,255,0.88);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.9rem;
    line-height: 1.4;
  }
  .py-stderr {
    border-color: rgba(255, 90, 90, 0.35);
    color: rgba(255, 185, 185, 0.92);
  }
  .py-stdout.is-empty, .py-stderr.is-empty { display: none; }

  .py-figure {
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.03);
  }
  .py-img { max-width: 100%; height: auto; display: none; border-radius: 8px; background: white; }
</style>

<script is:inline type="module" define:vars={{ uid }}>
  function init() {
    window.__PYODIDE_RUNNERS__ ??= new Set();
    if (window.__PYODIDE_RUNNERS__.has(uid)) return;
    window.__PYODIDE_RUNNERS__.add(uid);

    const root = document.querySelector(`[data-py-runner="${uid}"]`);
    if (!root) {
      requestAnimationFrame(() => init());
      return;
    }

    const editor = root.querySelector(".py-editor");
    const btn = root.querySelector(".py-run");
    const statusEl = root.querySelector(".py-status");
    const outEl = root.querySelector(".py-stdout");
    const errEl = root.querySelector(".py-stderr");
    const imgEl = root.querySelector(".py-img");

    function setStatus(s) { statusEl.textContent = s; }

    function refreshPanels() {
      if (outEl.textContent.trim() === "") outEl.classList.add("is-empty");
      else outEl.classList.remove("is-empty");

      if (errEl.textContent.trim() === "") errEl.classList.add("is-empty");
      else errEl.classList.remove("is-empty");
    }

    function clearIO() {
      outEl.textContent = "";
      errEl.textContent = "";
      imgEl.style.display = "none";
      imgEl.removeAttribute("src");
      refreshPanels();
    }

    function logErr(e) {
      const msg = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
      errEl.textContent += (errEl.textContent ? "\n" : "") + msg;
      console.error(e);
      refreshPanels();
    }

    function makeStdout() {
      return (s) => {
        outEl.textContent += s + "\n";
        refreshPanels();
      };
    }

    const globalKey = "__PYODIDE_SINGLETON__";
    async function getPyodide() {
      if (window[globalKey]) return window[globalKey];

      setStatus("Importing Pyodide loader…");
      const { loadPyodide } = await import("https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.mjs");

      setStatus("Downloading Pyodide runtime…");
      const pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/" });

      setStatus("Loading numpy + matplotlib…");
      await pyodide.loadPackage(["numpy", "matplotlib"]);

      window[globalKey] = pyodide;
      setStatus("Ready.");
      return pyodide;
    }

    setStatus("Ready to run. Click Run.");
    refreshPanels();

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      clearIO();
      try {
        const pyodide = await getPyodide();
        setStatus("Running…");

        pyodide.globals.set("__js_stdout__", makeStdout());
        const userCode = editor.value;

        const wrapped = `
import sys, io, base64, warnings
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt

warnings.filterwarnings("ignore", message="Matplotlib is currently using agg")

class _Writer:
    def write(self, s):
        if s is None: return
        s = str(s)
        if s == "": return
        __js_stdout__(s.rstrip("\\n"))
    def flush(self):
        return

sys.stdout = _Writer()
sys.stderr = _Writer()

# --- user code ---
${userCode}
# --- end user code ---

_png_b64 = None
try:
    fig = plt.gcf()
    if len(fig.axes) > 0:
        buf = io.BytesIO()
        fig.savefig(buf, format="png", bbox_inches="tight", dpi=150)
        buf.seek(0)
        _png_b64 = base64.b64encode(buf.read()).decode("ascii")
except Exception:
    _png_b64 = None

_png_b64
`;

        const b64 = await pyodide.runPythonAsync(wrapped);
        if (b64 && typeof b64 === "string") {
          imgEl.src = "data:image/png;base64," + b64;
          imgEl.style.display = "block";
        }
        setStatus("Done.");
        refreshPanels();
      } catch (e) {
        setStatus("Error.");
        logErr(e);
        errEl.textContent += "\n\nIf you see network/CSP errors in DevTools, GitHub Pages must allow cdn.jsdelivr.net and wasm downloads.";
        refreshPanels();
      } finally {
        btn.disabled = false;
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init, { once: true });
  } else {
    init();
  }
</script>

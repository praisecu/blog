---
const { title = "Python (Pyodide)", initialCode = "", height = 240, id, autoRun = false, packages = ["numpy","matplotlib","scipy","pandas"] } = Astro.props;
const uid = id ?? `py_${Math.random().toString(36).slice(2, 10)}`;
---

<section class="py-runner" data-py-runner={uid}>
  {title && <h3 class="py-title">{title}</h3>}

  <div class="py-window">
    <div class="py-windowbar">
      <div class="py-windowtitle">python</div>

      <button class="py-copy" type="button" aria-label="Copy code">
        <svg class="py-copyicon" viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
          <path fill="currentColor" d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1Zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H10V7h9v14Z"/>
        </svg>
        <span class="py-copytext">Copy</span>
      </button>
    </div>

    <div class="py-body">
      <div class="py-editorwrap" style={`height:${height}px`}>
        <div class="py-codepane">
          <!-- Line numbers (non-interactive, synced to textarea scroll via transform) -->
          <div class="py-gutter" aria-hidden="true"><pre class="py-linenos"></pre></div>

          <!-- Highlight layer -->
          <pre class="py-highlight" aria-hidden="true"><code class="language-python"></code></pre>

          <!-- Input layer -->
          <textarea class="py-editor" wrap="off" spellcheck="false">{initialCode}</textarea>
        </div>
      </div>

      <div class="py-actions">
        <button class="py-run" type="button">Run</button>
        <span class="py-status">Idle.</span>
      </div>

      <pre class="py-stdout is-empty" aria-label="stdout"></pre>
      <pre class="py-stderr is-empty" aria-label="stderr"></pre>

      <div class="py-figure">
        <img class="py-img" alt="matplotlib output" />
      </div>
    </div>
  </div>
</section>

<style>
  /* Theme bridge:
     Your site uses <html data-theme="dark"> for dark mode and removes it for light mode.
     We define CSS variables for light on :root, then override for [data-theme="dark"].
  */
  :global(:root) {
    --py-surface: #ffffff;
    --py-surface-2: #f6f7f9;
    --py-panel: #ffffff;
    --py-panel-2: #f3f4f6;
    --py-border: rgba(0,0,0,0.12);
    --py-border-2: rgba(0,0,0,0.10);
    --py-text: rgba(17,24,39,0.94);
    --py-muted: rgba(17,24,39,0.60);
    --py-mono: "JetBrains Mono", "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --py-shadow: 0 12px 30px rgba(0,0,0,0.10);
    --py-selection: rgba(37, 99, 235, 0.22);

    --py-pad-x: 14px;
    --py-pad-y: 14px;
    --py-gutter-w: 3.25rem;
    --py-linenum: color-mix(in srgb, var(--py-muted) 78%, var(--py-token-function) 22%);

    --py-scroll-track: rgba(0,0,0,0.04);
    --py-scroll-thumb: rgba(0,0,0,0.22);
    --py-scroll-thumb-hover: rgba(0,0,0,0.32);

    /* Token colors (light) */
    --py-token-comment: rgba(100,116,139,0.85);
    --py-token-keyword: #6d28d9;
    --py-token-string: #047857;
    --py-token-number: #b45309;
    --py-token-function: #1d4ed8;
    --py-token-operator: rgba(17,24,39,0.85);
    --py-token-punctuation: rgba(17,24,39,0.65);
    --py-token-builtin: #047857;
    --py-token-class: #1d4ed8;
    --py-token-boolean: #b45309;
  }

  :global([data-theme="dark"]) {
    --py-surface: #0f1117;
    --py-surface-2: #0b0d12;
    --py-panel: #0f1117;
    --py-panel-2: #0b0d12;
    --py-border: rgba(255,255,255,0.14);
    --py-border-2: rgba(255,255,255,0.10);
    --py-text: rgba(255,255,255,0.92);
    --py-muted: rgba(255,255,255,0.68);
    --py-shadow: 0 12px 30px rgba(0,0,0,0.35);
    --py-selection: rgba(130,170,255,0.35);

    --py-linenum: color-mix(in srgb, var(--py-muted) 78%, var(--py-token-function) 22%);

    --py-scroll-track: rgba(255,255,255,0.04);
    --py-scroll-thumb: rgba(255,255,255,0.28);
    --py-scroll-thumb-hover: rgba(255,255,255,0.38);

    /* Token colors (dark) */
    --py-token-comment: rgba(148,163,184,0.80);
    --py-token-keyword: #a78bfa;
    --py-token-string: #34d399;
    --py-token-number: #f59e0b;
    --py-token-function: #60a5fa;
    --py-token-operator: rgba(226,232,240,0.85);
    --py-token-punctuation: rgba(226,232,240,0.75);
    --py-token-builtin: #34d399;
    --py-token-class: #60a5fa;
    --py-token-boolean: #f59e0b;
  }

  .py-runner { margin: 1.5rem 0; }
  .py-title { margin: 0 0 0.75rem 0; }

  .py-window {
    border-radius: 14px;
    border: 1px solid var(--py-border);
    overflow: hidden;
    background: var(--py-surface);
    box-shadow: var(--py-shadow);
  }

  .py-windowbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 12px;
    background: color-mix(in srgb, var(--py-surface) 92%, transparent);
    border-bottom: 1px solid var(--py-border-2);
  }

  .py-windowtitle {
    font-size: 0.85rem;
    letter-spacing: 0.02em;
    color: var(--py-muted);
    user-select: none;
  }

  .py-copy {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--py-border-2);
    background: color-mix(in srgb, var(--py-surface) 90%, transparent);
    color: var(--py-text);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
  }
  .py-copy:hover { background: color-mix(in srgb, var(--py-surface) 82%, transparent); }
  .py-copy:disabled { opacity: 0.7; cursor: default; }

  .py-body { padding: 14px; display: grid; gap: 12px; }

  .py-editorwrap {
    display: grid;
    grid-template-columns: 1fr;
    border-radius: 12px;
    border: 1px solid var(--py-border-2);
    background: var(--py-panel-2);
    overflow: hidden;
  }

  .py-codepane { position: relative; overflow: hidden; }

  .py-gutter {
    position: absolute;
    inset: 0 auto 0 0;
    width: var(--py-gutter-w);
    border-right: 1px solid var(--py-border-2);
    background: color-mix(in srgb, var(--py-panel-2) 92%, transparent);
    pointer-events: none;
    overflow: hidden; /* prevent independent scrolling */
    z-index: 2;
  }
  .py-linenos {
    margin: 0;
    padding: var(--py-pad-y) 10px var(--py-pad-y) 10px;
    font-family: var(--py-mono);
    font-size: 0.95rem;
    line-height: 1.45;
    tab-size: 4;
    white-space: pre;
    text-align: right;
    color: var(--py-linenum);
    user-select: none;
    will-change: transform;
  }

  .py-highlight, .py-editor {
    position: absolute;
    inset: 0;
    margin: 0;
    padding: var(--py-pad-y) var(--py-pad-x) var(--py-pad-y) calc(var(--py-pad-x) + var(--py-gutter-w));
    font-family: var(--py-mono);
    font-size: 0.95rem;
    line-height: 1.45;
    tab-size: 4;
    white-space: pre;

    /* Keep overlay layers pixel-identical */
    box-sizing: border-box;
    font-weight: 400;
    letter-spacing: 0;
    font-variant-ligatures: none;
    -webkit-text-size-adjust: 100%;
  }

  .py-highlight {
    /* Do NOT make the highlight layer an independent scroll container.
       We translate the <code> element to match the textarea scroll offsets.
       This avoids 1px/line drift under zoom/subpixel rendering. */
    overflow: hidden;
    pointer-events: none;
    color: var(--py-text);
  }
  .py-highlight code { display: block; will-change: transform; }

  /* Hide highlight scrollbars but keep the same scrollbar gutter as the textarea */
  .py-highlight::-webkit-scrollbar { width: 0; height: 0; }
  .py-highlight { scrollbar-width: none; }

  .py-editor { scrollbar-gutter: stable; }


  .py-editor {
    border: 0;
    outline: none;
    resize: none;
    background: transparent;
    overflow: auto;
    color: transparent;
    caret-color: var(--py-text);
  }
  .py-editor::selection { background: var(--py-selection); }

  /* Modern scrollbars */
  .py-editor::-webkit-scrollbar { width: 10px; height: 10px; }
  .py-editor::-webkit-scrollbar-track { background: var(--py-scroll-track); border-radius: 999px; }
  .py-editor::-webkit-scrollbar-thumb {
    background: var(--py-scroll-thumb);
    border-radius: 999px;
    border: 2px solid rgba(0,0,0,0);
    background-clip: padding-box;
  }
  .py-editor::-webkit-scrollbar-thumb:hover { background: var(--py-scroll-thumb-hover); background-clip: padding-box; }
  .py-editor::-webkit-scrollbar-corner { background: transparent; }
  .py-editor { scrollbar-width: thin; scrollbar-color: var(--py-scroll-thumb) var(--py-scroll-track); }

  .py-editorwrap:has(.py-editor:focus) {
    border-color: color-mix(in srgb, var(--py-token-function) 55%, transparent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--py-token-function) 18%, transparent);
  }

  /* Prism token colors must be global (Prism inserts spans without Astro scope attrs) */
  :global(.token.comment) { color: var(--py-token-comment); }
  :global(.token.keyword) { color: var(--py-token-keyword); }
  :global(.token.string) { color: var(--py-token-string); }
  :global(.token.number) { color: var(--py-token-number); }
  :global(.token.function) { color: var(--py-token-function); }
  :global(.token.operator) { color: var(--py-token-operator); }
  :global(.token.punctuation) { color: var(--py-token-punctuation); }
  :global(.token.builtin) { color: var(--py-token-builtin); }
  :global(.token.class-name) { color: var(--py-token-class); }
  :global(.token.boolean) { color: var(--py-token-boolean); }

  .py-actions { display: flex; align-items: center; gap: 10px; }
  .py-run {
    padding: 0.45rem 0.9rem;
    border-radius: 999px;
    border: 1px solid var(--py-border-2);
    background: color-mix(in srgb, var(--py-surface) 90%, transparent);
    color: var(--py-text);
    cursor: pointer;
    font-weight: 600;
  }
  .py-run:hover { background: color-mix(in srgb, var(--py-surface) 82%, transparent); }
  .py-run:disabled { opacity: 0.6; cursor: not-allowed; }

  .py-status { font-size: 0.95rem; color: var(--py-muted); }

  .py-stdout, .py-stderr {
    white-space: pre;
    overflow-x: auto;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--py-border-2);
    background: var(--py-panel-2);
    color: var(--py-text);
    font-family: var(--py-mono);
    font-size: 0.9rem;
    line-height: 1.4;
  }
  .py-stdout {
    font-variant-numeric: tabular-nums;
  }
  .py-stderr {
    border-color: color-mix(in srgb, #ef4444 35%, var(--py-border-2));
    color: color-mix(in srgb, #ef4444 70%, var(--py-text));
  }
  .py-stdout.is-empty, .py-stderr.is-empty { display: none; }

  .py-figure {
    padding: 12px;
    border-radius: 12px;
    border: 1px solid var(--py-border-2);
    background: color-mix(in srgb, var(--py-surface) 92%, transparent);
  }
  .py-img { max-width: 100%; height: auto; display: none; border-radius: 8px; background: white; }
</style>

<script is:inline type="module" define:vars={{ uid, packages, autoRun }}>
  async function ensurePrism() {
    if (window.Prism?.languages?.python) return;

    const loadScript = (src) => new Promise((resolve, reject) => {
      const s = document.createElement("script");
      s.src = src;
      s.async = true;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error("Failed to load " + src));
      document.head.appendChild(s);
    });

    // Use prism.min.js (full core) + python grammar
    await loadScript("https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js");
    await loadScript("https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js");
  }

  async function init() {
    window.__PYODIDE_RUNNERS__ ??= new Set();
    if (window.__PYODIDE_RUNNERS__.has(uid)) return;
    window.__PYODIDE_RUNNERS__.add(uid);

    const root = document.querySelector(`[data-py-runner="${uid}"]`);
    if (!root) { requestAnimationFrame(() => init()); return; }

    const editor = root.querySelector(".py-editor");
    const highlightPre = root.querySelector(".py-highlight");
    const highlightCode = root.querySelector(".py-highlight code");
    const gutterPre = root.querySelector(".py-linenos");

    const btn = root.querySelector(".py-run");
    const copyBtn = root.querySelector(".py-copy");
    const copyText = root.querySelector(".py-copytext");
    const statusEl = root.querySelector(".py-status");
    const outEl = root.querySelector(".py-stdout");
    const errEl = root.querySelector(".py-stderr");
    const imgEl = root.querySelector(".py-img");

    let pkgList = packages;
    // Normalize packages prop (Astro may serialize it as JSON)
    if (!Array.isArray(pkgList)) {
      try { pkgList = JSON.parse(String(pkgList)); } catch { pkgList = ["numpy","matplotlib","scipy","pandas"]; }
    }
    pkgList = pkgList.filter((p) => typeof p === "string" && p.trim().length > 0);

    function setStatus(s) { statusEl.textContent = s; }

    function refreshPanels() {
      if (outEl.textContent.trim() === "") outEl.classList.add("is-empty");
      else outEl.classList.remove("is-empty");

      if (errEl.textContent.trim() === "") errEl.classList.add("is-empty");
      else errEl.classList.remove("is-empty");
    }

    function clearIO() {
      outEl.textContent = "";
      errEl.textContent = "";
      imgEl.style.display = "none";
      imgEl.removeAttribute("src");
      refreshPanels();
    }

    function logErr(e) {
      const msg = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e);
      errEl.textContent += (errEl.textContent ? "\n" : "") + msg;
      console.error(e);
      refreshPanels();
    }

    function makeStdout() {
      return (s) => { outEl.textContent += s + "\n"; refreshPanels(); };
    }

    // Ensure the textarea and highlight layer share identical *computed* metrics.
    // Textareas can end up with different effective line-height/font metrics vs <pre> under
    // zoom/subpixel rendering; if they diverge, clicks appear to land on the wrong line.
    function syncMetrics() {
      const cs = getComputedStyle(editor);
      const lh = cs.lineHeight;
      const fs = cs.fontSize;
      const ff = cs.fontFamily;
      const pt = cs.paddingTop;
      const pr = cs.paddingRight;
      const pb = cs.paddingBottom;
      const pl = cs.paddingLeft;

      // Highlight layer: match the textarea exactly.
      highlightPre.style.lineHeight = lh;
      highlightPre.style.fontSize = fs;
      highlightPre.style.fontFamily = ff;
      highlightPre.style.paddingTop = pt;
      highlightPre.style.paddingRight = pr;
      highlightPre.style.paddingBottom = pb;
      highlightPre.style.paddingLeft = pl;

      // Gutter should match vertical metrics (but not the text padding-left that
      // includes the gutter width).
      if (gutterPre) {
        gutterPre.style.lineHeight = lh;
        gutterPre.style.fontSize = fs;
        gutterPre.style.fontFamily = ff;
        gutterPre.style.paddingTop = pt;
        gutterPre.style.paddingBottom = pb;
      }
    }

    let lastLineCount = 0;
    function updateLineNumbers() {
      if (!gutterPre) return;
      // Split preserves trailing empty line when text ends with \n
      const n = editor.value.split("\n").length;
      if (n === lastLineCount) return;
      lastLineCount = n;
      let out = "";
      for (let i = 1; i <= n; i++) out += i + "\n";
      gutterPre.textContent = out;
    }

    function syncScroll() {
      const y = editor.scrollTop;
      const x = editor.scrollLeft;
      // Keep highlight layer aligned with the textarea scroll.
      // Do not scroll the <pre>; translate the <code> instead. This keeps
      // caret/click mapping stable under zoom and fractional line heights.
      if (highlightCode) {
        highlightCode.style.transform = `translate(${-x}px, ${-y}px)`;
      }

      if (gutterPre) {
        gutterPre.style.transform = `translateY(${-y}px)`;
      }
    }

    let prismReady = false;
    async function renderHighlight() {
      if (!highlightCode) return;

      if (!prismReady) {
        try {
          await ensurePrism();
          prismReady = true;
        } catch (e) {
          highlightCode.textContent = editor.value;
          return;
        }
      }
      const code = editor.value;
      highlightCode.innerHTML = window.Prism.highlight(code, window.Prism.languages.python, "python");
    }

    editor.addEventListener("input", async () => {
      updateLineNumbers();
      await renderHighlight();
      syncScroll();
    });
    editor.addEventListener("scroll", syncScroll);

    // Focus mode: show native textarea rendering for perfect caret/selection.
    // Blur mode: show Prism highlighting (textarea text becomes transparent).
    const showPlain = () => {
      highlightPre.style.visibility = "hidden";
      editor.style.color = "var(--py-text)";
    };
    const showHighlighted = async () => {
      editor.style.color = "transparent";
      highlightPre.style.visibility = "visible";
      await renderHighlight();
      syncScroll();
    };

    editor.addEventListener("focus", showPlain);
    editor.addEventListener("blur", () => { void showHighlighted(); });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(editor.value);
        const prev = copyText.textContent;
        copyText.textContent = "Copied";
        copyBtn.disabled = true;
        setTimeout(() => { copyText.textContent = prev; copyBtn.disabled = false; }, 900);
      } catch (e) {
        editor.select();
        document.execCommand("copy");
        editor.setSelectionRange(editor.value.length, editor.value.length);
      }
    });

    // Initialize
    syncMetrics();
    updateLineNumbers();
    await renderHighlight();
    syncScroll();
    refreshPanels();
    setStatus("Ready to run. Click Run.");

    // Auto-run if enabled
    const shouldAutoRun = (autoRun === true) || (String(autoRun) === "true");
    if (shouldAutoRun) {
      // ensure layout/paint done, then run once
      requestAnimationFrame(() => btn.click());
    }

    // Re-sync if fonts/zoom/layout change.
    window.addEventListener("resize", () => { syncMetrics(); syncScroll(); });
    if (document.fonts?.ready) {
      document.fonts.ready.then(() => { syncMetrics(); syncScroll(); }).catch(() => {});
    }

    // Pyodide
    const globalKey = "__PYODIDE_SINGLETON__";
    async function getPyodide() {
      if (window[globalKey]) return window[globalKey];

      setStatus("Importing Pyodide loader…");
      const { loadPyodide } = await import("https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.mjs");

      setStatus("Downloading Pyodide runtime…");
      const pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.26.2/full/" });

      setStatus(`Loading packages: ${pkgList.join(", ")}…`);
      await pyodide.loadPackage(pkgList);
window[globalKey] = pyodide;
      setStatus("Ready.");
      return pyodide;
    }

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      clearIO();
      try {
        const pyodide = await getPyodide();
        setStatus("Running…");

        pyodide.globals.set("__js_stdout__", makeStdout());
        const userCode = editor.value;

        const wrapped = `
import sys, io, base64, warnings
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
warnings.filterwarnings("ignore", message="Matplotlib is currently using agg")

class _Writer:
    def write(self, s):
        if s is None: return
        s = str(s)
        if s == "": return
        __js_stdout__(s.rstrip("\\\\n"))
    def flush(self):
        return

sys.stdout = _Writer()
sys.stderr = _Writer()

# --- user code ---
${userCode}
# --- end user code ---

_png_b64 = None
try:
    fig = plt.gcf()
    if len(fig.axes) > 0:
        buf = io.BytesIO()
        fig.savefig(buf, format="png", bbox_inches="tight", dpi=150)
        buf.seek(0)
        _png_b64 = base64.b64encode(buf.read()).decode("ascii")
except Exception:
    _png_b64 = None

_png_b64
`;
        const b64 = await pyodide.runPythonAsync(wrapped);
        if (b64 && typeof b64 === "string") {
          imgEl.src = "data:image/png;base64," + b64;
          imgEl.style.display = "block";
        }
        setStatus("Done.");
        refreshPanels();
      } catch (e) {
        setStatus("Error.");
        logErr(e);
        errEl.textContent += "\n\nIf you see network/CSP errors in DevTools, GitHub Pages must allow cdn.jsdelivr.net and wasm downloads.";
        refreshPanels();
      } finally {
        btn.disabled = false;
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => { init(); }, { once: true });
  } else {
    init();
  }
</script>
